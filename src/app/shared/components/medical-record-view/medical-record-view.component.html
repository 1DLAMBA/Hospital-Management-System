<p-dialog [(visible)]="visible" (visibleChange)="visibleChange.emit($event)" [modal]="true" [closable]="true" [dismissableMask]="true" 
    [style]="{width: '700px', maxWidth: '95vw'}" [baseZIndex]="10000" 
    styleClass="modern-medical-record-view-dialog" [showHeader]="false">
  <div class="med-record-view-container">
    <!-- Compact Header -->
    <div class="med-record-view-header">
      <h3>Medical Record</h3>
      <button type="button" class="close-btn" (click)="closeDialog()" aria-label="Close">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <!-- Main Content -->
    <div class="med-record-view-body">
      <div id="printable-med-record">
        <!-- Patient Information -->
        <div class="patient-info-section">
          <div class="patient-photo-container">
            <img *ngIf="client?.user?.passport" 
                 [src]="avatar_file + (client?.user?.passport || '')" 
                 alt="Patient Photo" 
                 class="patient-photo" />
            <div *ngIf="!client?.user?.passport" class="patient-photo-placeholder">
              <i class="pi pi-user"></i>
            </div>
          </div>
          <div class="patient-details-list">
            <div class="detail-row">
              <span class="detail-label">Patient:</span>
              <span class="detail-value">{{client?.user?.name || 'N/A'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Record #:</span>
              <span class="detail-value record-number">{{medicalRecord?.record_number || 'N/A'}}</span>
            </div>
            <div *ngIf="medicalRecord?.other_professional" class="detail-row">
              <span class="detail-label">Doctor:</span>
              <span class="detail-value">{{medicalRecord?.other_professional?.user?.name || 'N/A'}}</span>
            </div>
            <div *ngIf="medicalRecord?.doctor" class="detail-row">
              <span class="detail-label">Doctor:</span>
              <span class="detail-value">{{medicalRecord?.doctor?.user?.name || 'N/A'}}</span>
            </div>
            <div *ngIf="medicalRecord?.doctor" class="detail-row">
              <span class="detail-label">Specialization:</span>
              <span class="detail-value">{{medicalRecord?.doctor?.specialization || 'N/A'}}</span>
            </div>
            <div *ngIf="medicalRecord?.other_professional" class="detail-row">
              <span class="detail-label">Specialization:</span>
              <span class="detail-value">{{medicalRecord?.other_professional?.specialization || 'N/A'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Date:</span>
              <span class="detail-value">{{medicalRecord?.created_at ? ((medicalRecord?.created_at | date:'medium') || 'N/A') : 'N/A'}}</span>
            </div>
          </div>
        </div>

        <!-- Medical Information Sections -->
        <div class="medical-sections-container">
          <div class="medical-section">
            <h4 class="section-title">Diagnosis</h4>
            <p class="section-text" *ngIf="medicalRecord?.diagnosis; else noDiagnosis">{{medicalRecord?.diagnosis}}</p>
            <ng-template #noDiagnosis>
              <p class="section-text-empty">No diagnosis recorded</p>
            </ng-template>
          </div>

          <div class="medical-section">
            <h4 class="section-title">Past Diagnosis</h4>
            <p class="section-text" *ngIf="medicalRecord?.past_diagnosis; else noPastDiagnosis">{{medicalRecord?.past_diagnosis}}</p>
            <ng-template #noPastDiagnosis>
              <p class="section-text-empty">No past diagnosis recorded</p>
            </ng-template>
          </div>

          <div class="medical-section">
            <h4 class="section-title">Treatment</h4>
            <p class="section-text" *ngIf="medicalRecord?.treatment; else noTreatment">{{medicalRecord?.treatment}}</p>
            <ng-template #noTreatment>
              <p class="section-text-empty">No treatment prescribed</p>
            </ng-template>
          </div>

          <div class="medical-section">
            <h4 class="section-title">Allergies</h4>
            <p class="section-text" *ngIf="medicalRecord?.allergies; else noAllergies">{{medicalRecord?.allergies}}</p>
            <ng-template #noAllergies>
              <p class="section-text-empty">No known allergies</p>
            </ng-template>
          </div>
        </div>

        <!-- Signature Section - Embedded in Medical Record Layout -->
        <div class="signature-section" *ngIf="medicalRecord?.doctor?.signature">
          <div class="signature-wrapper">
            <div class="signature-container">
              <div class="signature-label">Attending Physician Signature</div>
              <div class="signature-image-wrapper">
                <img [src]="avatar_file + (medicalRecord?.doctor?.signature || '')" 
                     alt="Doctor Signature" 
                     class="signature-image" />
              </div>
              <div class="doctor-name">{{medicalRecord?.doctor?.user?.name || 'N/A'}}</div>
              <div class="doctor-credentials" *ngIf="medicalRecord?.doctor?.specialization">
                {{medicalRecord?.doctor?.specialization}}
              </div>
            </div>
            <div class="signature-date">
              <div class="date-label">Date:</div>
              <div class="date-value">{{medicalRecord?.created_at ? ((medicalRecord?.created_at | date:'short') || 'N/A') : 'N/A'}}</div>
            </div>
          </div>
        </div>

        <!-- Footer Information -->
        <div class="record-footer-info">
          <small>Generated by HMS | {{medicalRecord?.created_at ? ((medicalRecord?.created_at | date:'medium') || 'N/A') : 'N/A'}}</small>
        </div>
      </div>
    </div>

    <!-- Action Footer -->
    <div class="med-record-view-footer">
      <button type="button" class="action-btn secondary-btn" (click)="closeDialog()">
        Close
      </button>
      <button type="button" class="action-btn primary-btn" (click)="printMedRecord()">
        <i class="pi pi-print"></i>
        Print
      </button>
    </div>
  </div>
</p-dialog>
