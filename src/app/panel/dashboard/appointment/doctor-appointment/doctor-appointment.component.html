<p-dialog header="Appointment Details" [(visible)]="apptDetails" [modal]="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{ width: '50vw' }"
    [draggable]="false" [resizable]="false" styleClass="modern-dialog">
    <ng-template pTemplate="header">
        <div class="dialog-header">
            <h2>Appointment Details</h2>
        </div>
    </ng-template>
    
    <div class="appointment-container" *ngIf="singleAppt">
        <!-- Client Info Section -->
        <div class="client-section">
            <div class="client-header">
                <div class="avatar-container">
                    <img [src]="avatar_file + singleAppt.client.user.passport" alt="Client Photo" class="client-avatar">
                </div>
                
                <div class="status-badge" [ngClass]="{
                    'status-pending': singleAppt.status === 'pending',
                    'status-accepted': singleAppt.status === 'Accepted',
                    'status-declined': singleAppt.status === 'Declined'
                }">
                    {{ singleAppt.status }}
                </div>
            </div>
            
            <div class="client-details">
                <div class="detail-row">
                    <h3 class="client-name">{{ singleAppt.client.user.name }}</h3>
                </div>
                
                <div class="detail-row">
                    <div class="detail-icon">
                        <i class="pi pi-calendar"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Appointment Date</span>
                        <span class="detail-value">{{ singleAppt.date_time | date:'medium' }}</span>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-icon">
                        <i class="pi pi-phone"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Phone</span>
                        <span class="detail-value">{{ singleAppt.client.user.phoneno }}</span>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-icon">
                        <i class="pi pi-envelope"></i>
                    </div>
                    <div class="detail-content">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">{{ singleAppt.client.user.email }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Complaints Section -->
        <div class="complaints-section">
            <h4 class="section-title">Complaints</h4>
            <p class="complaints-text">{{ singleAppt.symptoms }}</p>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <ng-container *ngIf="singleAppt.status === 'pending'">
                <p-button 
                    [label]="acceptLoading ? 'Accepting...' : 'Accept'" 
                    [icon]="acceptLoading ? 'pi pi-spin pi-spinner' : 'pi pi-check'" 
                    [disabled]="btnDisable || acceptLoading" 
                    [loading]="acceptLoading"
                    styleClass="p-button-raised p-button-success" 
                    (click)="status(singleAppt.id, 'Accepted')">
                </p-button>
                
                <p-button 
                    label="Decline" 
                    icon="pi pi-times" 
                    [disabled]="btnDisable" 
                    styleClass="p-button-raised p-button-danger" 
                    (click)="status(singleAppt.id, 'Declined')">
                </p-button>
            </ng-container>
            
            <ng-container *ngIf="singleAppt.status === 'Accepted' || singleAppt.status === 'Declined'">
                <p-button 
                    label="Cancel" 
                    icon="pi pi-undo" 
                    [disabled]="btnDisable" 
                    styleClass="p-button-raised p-button-warning" 
                    (click)="status(singleAppt.id, 'pending')">
                </p-button>
            </ng-container>
            
            <p-button 
                label="View Profile" 
                icon="pi pi-user" 
                styleClass="p-button-raised p-button-info" 
                routerLink="../clients/profile/{{singleAppt.client.id}}">
            </p-button>
        </div>
    </div>
</p-dialog>

<div class="container-fluid py-4">
    <!-- Loading skeletons -->
    <ng-container *ngIf="loading">
        <!-- Stats Cards Skeleton -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3" *ngFor="let i of [1, 2, 3]">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <p-skeleton shape="circle" size="3rem" styleClass="me-3"></p-skeleton>
                        <div>
                            <p-skeleton width="80px" height="1.5rem" styleClass="mb-2"></p-skeleton>
                            <p-skeleton width="120px" height="1rem"></p-skeleton>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Skeleton -->
        <div class="card">
            <div class="card-body">
                <!-- Search and Filter Skeleton -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <p-skeleton width="250px" height="2.5rem"></p-skeleton>
                    <div class="d-flex">
                        <p-skeleton width="150px" height="2.5rem" styleClass="me-3"></p-skeleton>
                        <p-skeleton width="150px" height="2.5rem"></p-skeleton>
                    </div>
                </div>

                <!-- Table Header Skeleton -->
                <div class="d-flex mb-3">
                    <p-skeleton width="15%" height="2.5rem" styleClass="me-3"></p-skeleton>
                    <p-skeleton width="20%" height="2.5rem" styleClass="me-3"></p-skeleton>
                    <p-skeleton width="20%" height="2.5rem" styleClass="me-3"></p-skeleton>
                    <p-skeleton width="15%" height="2.5rem" styleClass="me-3"></p-skeleton>
                    <p-skeleton width="15%" height="2.5rem"></p-skeleton>
                </div>

                <!-- Table Rows Skeleton -->
                <div *ngFor="let i of [1, 2, 3, 4, 5]" class="mb-3">
                    <div class="d-flex align-items-center">
                        <p-skeleton width="15%" height="2.5rem" styleClass="me-3"></p-skeleton>
                        <p-skeleton width="20%" height="1.5rem" styleClass="me-3"></p-skeleton>
                        <p-skeleton width="20%" height="1.5rem" styleClass="me-3"></p-skeleton>
                        <p-skeleton width="15%" height="1.5rem" styleClass="me-3"></p-skeleton>
                        <p-skeleton width="15%" height="2.5rem"></p-skeleton>
                    </div>
                </div>

                <!-- Pagination Skeleton -->
                <div class="d-flex justify-content-between mt-4">
                    <p-skeleton width="150px" height="2rem"></p-skeleton>
                    <div class="d-flex">
                        <p-skeleton width="2rem" height="2rem" styleClass="me-2"></p-skeleton>
                        <p-skeleton width="2rem" height="2rem"></p-skeleton>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- Actual Content -->
    <ng-container *ngIf="!loading">
        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-light-warning rounded p-3 me-3">
                            <i class="pi pi-calendar text-warning fs-2"></i>
                        </div>
                        <div>
                            <h2 class="mb-0">{{ pendingAppointment || 0 }}</h2>
                            <p class="text-muted mb-0">Pending Appointments</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-light-success rounded p-3 me-3">
                            <i class="pi pi-check-circle text-success fs-2"></i>
                        </div>
                        <div>
                            <h2 class="mb-0">{{ acceptedAppointment || 0 }}</h2>
                            <p class="text-muted mb-0">Accepted</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="bg-light-danger rounded p-3 me-3">
                            <i class="pi pi-times-circle text-danger fs-2"></i>
                        </div>
                        <div>
                            <h2 class="mb-0">{{ declinedAppointment || 0 }}</h2>
                            <p class="text-muted mb-0">Declined</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointments Table -->
        <div class="card">
            <div class="card-body">
                <p-table #dt1 [value]="appointment" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [paginator]="true"
                    [globalFilterFields]="['client.user.name', 'date_time', 'status']" [loading]="loading">

                    <ng-template pTemplate="header">
                        <tr>
                            <th style="min-width:7rem">
                                <div class="flex align-items-center">
                                    View
                                </div>
                            </th>
                            <th style="min-width:15rem">
                                <div class="flex align-items-center">
                                    Client Name
                                </div>
                            </th>
                            <th style="min-width:10rem">
                                <div class="flex align-items-center">
                                    Date and Time
                                </div>
                            </th>
                            <th style="min-width:5rem">
                                <div class="flex align-items-center">
                                    Status
                                </div>
                            </th>
                            <th style="min-width:10rem">
                                <div class="flex align-items-center">
                                    Phone Number
                                </div>
                            </th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-appt>
                        <tr>
                            <td>
                                <p-button styleClass="view-button" label="View" severity="info" [raised]="true" [rounded]="true"
                                    (click)="viewAppt(appt.id)" />
                            </td>
                            <td class="d-flex">
                                <div class="passport">
                                    <img [src]="avatar_file + appt.client.user.passport">
                                </div>
                                {{ appt.client.user.name }}
                            </td>
                            <td>
                                <span class="ml-1 vertical-align-middle">{{ appt.date_time | date:'medium' }}</span>
                            </td>
                            <td>
                                <span *ngIf="appt.status === 'pending'" class="ml-1 vertical-align-middle text-warning">{{ appt.status }}</span>
                                <span *ngIf="appt.status === 'Accepted'" class="ml-1 vertical-align-middle text-success">{{ appt.status }}</span>
                                <span *ngIf="appt.status === 'Declined'" class="ml-1 vertical-align-middle text-danger">{{ appt.status }}</span>
                            </td>
                            <td>
                                {{ appt.client.user.phoneno }}
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="5" class="text-center p-4">
                                <i class="pi pi-inbox" style="font-size: 2rem; color: #9e9e9e;"></i>
                                <p class="mt-2 mb-0">No appointments found</p>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </ng-container>
</div>