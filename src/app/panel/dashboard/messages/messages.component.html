<p-toast></p-toast>

<div class="messages-container">
    <!-- Header Section -->
    <div class="messages-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="bi bi-chat-dots"></i>
            </div>
            <div class="header-text">
                <h2>Messages</h2>
                <p *ngIf="!(loading$ | async)">{{conversations?.length || 0}} conversations</p>
                <div *ngIf="(loading$ | async)" class="loading-text">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>Loading conversations</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="refresh-btn" (click)="getConversation()" [disabled]="(loading$ | async)">
                <i class="bi bi-arrow-clockwise" [class.spinning]="(loading$ | async)"></i>
            </button>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input 
                type="text" 
                placeholder="Search conversations..." 
                class="search-input"
                [(ngModel)]="searchTerm"
                (input)="filterConversations()"
                [disabled]="(loading$ | async) || false">
        </div>
    </div>

    <!-- Conversations List -->
    <div class="conversations-section">
        <div class="conversations-header">
            <h4>Recent Conversations</h4>
            <div class="conversation-count" *ngIf="!(loading$ | async)">{{filteredConversations?.length || 0}}</div>
            <div class="conversation-count loading" *ngIf="(loading$ | async)">
                <div class="skeleton-text"></div>
            </div>
        </div>
        
        <!-- Loading Skeleton -->
        <div class="conversations-list" *ngIf="(loading$ | async)">
            <div class="conversation-item skeleton-item" *ngFor="let item of [1,2,3,4,5]">
                <div class="conversation-avatar">
                    <div class="skeleton-avatar"></div>
                </div>
                
                <div class="conversation-content">
                    <div class="conversation-header">
                        <div class="skeleton-name"></div>
                        <div class="skeleton-time"></div>
                    </div>
                    
                    <div class="conversation-preview">
                        <div class="skeleton-message"></div>
                        <div class="conversation-meta">
                            <div class="skeleton-badge"></div>
                        </div>
                    </div>
                </div>
                
                <div class="conversation-actions">
                    <div class="skeleton-button"></div>
                </div>
            </div>
        </div>
        
        <!-- Actual Conversations -->
        <div class="conversations-list" *ngIf="!(loading$ | async) && filteredConversations && filteredConversations.length > 0">
            <div 
                class="conversation-item" 
                *ngFor="let conversation of filteredConversations; trackBy: trackByConversation"
                (click)="openChat(conversation)"
                [class.unread]="hasUnreadMessages(conversation)">
                
                <div class="conversation-avatar">
                    <img 
                        *ngIf="conversation.user_two_id == this.id" 
                        [src]="avatar_file + conversation.user_one.passport"
                        [alt]="conversation.user_one.name">
                    <img 
                        *ngIf="conversation.user_one_id == this.id" 
                        [src]="avatar_file + conversation.user_two.passport"
                        [alt]="conversation.user_two.name">
                    <div class="online-indicator" *ngIf="isUserOnline(conversation)"></div>
                </div>
                
                <div class="conversation-content">
                    <div class="conversation-header">
                        <h5 class="conversation-name">
                            <span *ngIf="conversation.user_one_id == this.id">{{conversation.user_two.name}}</span>
                            <span *ngIf="conversation.user_two_id == this.id">{{conversation.user_one.name}}</span>
                        </h5>
                        <span class="conversation-time">{{conversation.updated_at | date:'short'}}</span>
                    </div>
                    
                    <div class="conversation-preview">
                        <p class="last-message">{{conversation.last_message || 'No messages yet'}}</p>
                        <div class="conversation-meta">
                            <span class="user-type" *ngIf="getUserType(conversation)">
                                {{getUserType(conversation)}}
                            </span>
                            <div class="unread-badge" *ngIf="hasUnreadMessages(conversation)">
                                <i class="bi bi-circle-fill"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="conversation-actions">
                    <button class="action-btn" (click)="openChat(conversation); $event.stopPropagation()">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="!(loading$ | async) && (!filteredConversations || filteredConversations.length === 0)">
            <div class="empty-icon">
                <i class="bi bi-chat"></i>
            </div>
            <h4>No conversations found</h4>
            <p *ngIf="searchTerm">No conversations match your search criteria.</p>
            <p *ngIf="!searchTerm">Start a conversation by messaging someone from their profile.</p>
        </div>
    </div>
</div>
