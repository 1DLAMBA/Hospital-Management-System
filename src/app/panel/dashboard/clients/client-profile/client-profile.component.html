<!-- ////DIALOG -->
<div class="card flex flex-column align-items-center gap-2">

    <p-dialog [modal]="true" [blockScroll]="true" [showHeader]="true" [closable]="true" [dismissableMask]="true" [closeOnEscape]="true" [(visible)]="visibleMsg" [style]="{ width: '50rem', height: '30rem' }" [contentStyle]="{ overflow: 'hidden', padding: '0' }">
        <div class="chat-container">
            <div #messageContainer class="chat-window">
                <div class="message-container" *ngFor="let message of messages">
                    <div [ngClass]="{ 'user-message': message.sender_id === user_id, 'bot-message': message.sender_id !== user_id }">
                        <div class="message-bubble">
                            <p>{{ message.message }}</p>
                            <span class="message-time">{{ message.created_at | date:'MMM d, yyyy, h:mm:ss a' }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <input pInputText [(ngModel)]="newMessage" placeholder="Type your message..." (keyup.enter)="sendMessage()" />
                <button pButton type="button" class="bi" icon="bi bi-send" (click)="sendMessage()"></button>
            </div>
        </div>

    </p-dialog>
</div>

<!-- Medical Record Creation Dialog -->
<p-dialog [(visible)]="display" [modal]="true" [closable]="true" 
    [style]="{width: '600px', maxWidth: '90vw'}" [baseZIndex]="10000" styleClass="modern-medical-record-dialog"
    [showHeader]="false">
    
    <form [formGroup]="medicalRecordForm" (ngSubmit)="onSubmit()">
      <div class="med-record-container">
        <!-- Header -->
        <div class="med-record-header">
          <div class="header-content">
            <div class="header-icon">
              <i class="pi pi-file"></i>
            </div>
            <div class="header-text">
              <h3>Medical Record</h3>
              <p>{{singleClient?.user?.name}}</p>
            </div>
          </div>
          <button type="button" class="close-btn" (click)="display=false">
            <i class="pi pi-times"></i>
          </button>
        </div>
        
        <!-- Form Body -->
        <div class="med-record-body">
          <!-- Hidden fields -->
        
          <input type="hidden" formControlName="record_number">
          
          <div class="form-field">
            <label for="diagnosis">Diagnosis <span class="required">*</span></label>
            <textarea 
              id="diagnosis" 
              formControlName="diagnosis" 
              rows="3"
              placeholder="Enter patient diagnosis"></textarea>
            <small *ngIf="medicalRecordForm.get('diagnosis')?.touched && medicalRecordForm.get('diagnosis')?.hasError('required')" 
              class="error-message">
              Diagnosis is required
            </small>
          </div>
          
          <div class="form-field">
            <label for="treatment">Treatment <span class="required">*</span></label>
            <textarea 
              id="treatment" 
              formControlName="treatment" 
              rows="3"
              placeholder="Enter prescribed treatment plan"></textarea>
            <small *ngIf="medicalRecordForm.get('treatment')?.touched && medicalRecordForm.get('treatment')?.hasError('required')" 
              class="error-message">
              Treatment is required
            </small>
          </div>
          
          <div class="form-row">
            <div class="form-field">
              <label for="past_diagnosis">Past Diagnosis</label>
              <textarea 
                id="past_diagnosis" 
                formControlName="past_diagnosis" 
                rows="2"
                placeholder="Enter any past diagnoses"></textarea>
            </div>
            
            <div class="form-field">
              <label for="allergies">Allergies</label>
              <textarea 
                id="allergies" 
                formControlName="allergies" 
                rows="2"
                placeholder="List any known allergies"></textarea>
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <div class="med-record-footer">
          <button type="button" class="cancel-btn" (click)="display=false">
            Cancel
          </button>
          <button type="submit" class="save-btn" [disabled]="medicalRecordForm.invalid">
            Save Record
          </button>
        </div>
      </div>
    </form>
</p-dialog>
<p-dialog header="Assign Nurse" [(visible)]="createAssignDiag" [modal]="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{ width: '40vw', display: 'flex'}"
    [draggable]="false" [resizable]="false">

    <div *ngIf="singleClient" class="">
        <h3>Assign {{user.name}} to {{singleClient.user.name}}</h3>
        <form [formGroup]="assignForm">
            <!-- <label for="diagnosis">Provide Diagnosis for patient</label><br>
                <input formControlName="diagnosis" placeholder="Patient Diagnosis" name="diagnosis"
                    type="name" pInputText id="name" aria-describedby="username-help"/>
                <small *ngIf="assignForm.get('diagnosis')?.touched && assignForm.get('name')?.hasError('required')"
                    class="text-danger">
                    Field Required
                </small><br> -->

            <label for="assignment_message">Provide assignment message</label><br>
            <textarea formControlName="assignment_message" placeholder="Provide Task for nurse"
                name="assignment_message" type="name" pInputText id="name" aria-describedby="username-help"></textarea>
            <small *ngIf="assignForm.get('assignment_message')?.touched && assignForm.get('name')?.hasError('required')"
                class="text-danger">
                Field Required
            </small><br>
            <p-button [disabled]="this.assignForm.invalid" label="Proceed" (click)="createAssign()" severity="info"
                [raised]="true" [rounded]="true" />
        </form>
    </div>



</p-dialog>

<p-dialog header="Select Client" [(visible)]="assignDialog" [modal]="true"
    [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" [style]="{ width: '60vw', display: 'flex'}"
    [draggable]="false" [resizable]="false">
    <p-table #dt1 [value]="nurses" dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [paginator]="true"
        [globalFilterFields]="['client.user.name', 'client.user.gender', 'client.date_of_birth']">


        <ng-template pTemplate="caption">
            <div class="flex">
                <p-button pRipple size="small" label="Clear" [outlined]="true" icon="pi pi-filter-slash" />
                <span class="p-input-icon-left ml-auto">
                    <i class="pi pi-search"></i>
                    <!-- <input pInputText type="text" [(ngModel)]="searchValue" (input)="dt1.filterGlobal($event.target?.addEventListener, 'contains')" placeholder="Search keyword" /> -->
                </span>
                <!-- <p-button pRipple size="small" label="Create Medical Record" severity="success" [outlined]="true" icon="pi pi-filter-slash" /> -->

            </div>
        </ng-template>
        <ng-template pTemplate="header">
            <tr>
                <th style="min-width:7rem">
                    <div class="flex align-items-center">
                        Nurse Name
                        <!-- <p-columnFilter type="text" field="name" display="menu" /> -->
                    </div>
                </th>

                <th style="min-width:15rem">
                    <div class="flex align-items-center">
                        Availability
                        <p-columnFilter type="text" field="name" display="menu" />
                    </div>
                </th>
                <th style="min-width:10rem">
                    <div class="flex align-items-center">
                        Phone Number
                        <p-columnFilter type="text" field="country.name" display="menu" />
                    </div>
                </th>
                <th style="min-width:10rem">
                    <div class="flex align-items-center">
                        Assign
                    </div>
                </th>



            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-nurse>
            <tr>
                <td>
                    <!-- <p-button label="View" severity="info" [raised]="true"  [rounded]="true" routerLink="profile/{{client.id}}"/> -->
                    {{nurse.user.name}}
                </td>
                <td class="d-flex">
                    {{nurse.availability}}

                </td>
                <td>
                    {{nurse.user.phoneno}}

                </td>
                <td>
                    <p-button pRipple size="small" [disabled]="disableAssignBtn" [outlined]="true"
                        icon="bi bi-calendar-plus" (click)="nurseSelect(nurse.id)" />


                </td>




            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7">No Assignments found.</td>
            </tr>
        </ng-template>


    </p-table>

</p-dialog>

<main class="d-flex flex-column">

    <section class="hero p-3">

        <!-- <p>{{singleClient.user.name}}</p> -->
    </section>

    <!-- Skeleton Loader -->
    <section class="main mx-auto d-flex flex-wrap justify-content-between" *ngIf="isLoading">
        <div class="left-profile">
            <div class="inner-profile pb-2">
                <p-skeleton width="100%" height="250px" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="80%" height="2rem" styleClass="m-2"></p-skeleton>
            </div>
            <p-skeleton width="40%" height="1.5rem" styleClass="mb-2"></p-skeleton>
            <div class="d-flex subs mt-2 justify-content-between">
                <p-skeleton width="40%" height="1rem"></p-skeleton>
                <p-skeleton width="50%" height="1rem"></p-skeleton>
            </div>
            <div class="d-flex subs justify-content-between">
                <p-skeleton width="30%" height="1rem"></p-skeleton>
                <p-skeleton width="40%" height="1rem"></p-skeleton>
            </div>
            <p-skeleton width="100%" height="1px" styleClass="my-2"></p-skeleton>
            <p-skeleton width="40%" height="1.5rem" styleClass="mb-2"></p-skeleton>
            <div class="d-flex subs mt-2 justify-content-between">
                <p-skeleton width="40%" height="1rem"></p-skeleton>
                <p-skeleton width="50%" height="1rem"></p-skeleton>
            </div>
            <div class="d-flex subs justify-content-between">
                <p-skeleton width="25%" height="1rem"></p-skeleton>
                <p-skeleton width="60%" height="1rem"></p-skeleton>
            </div>
            <div class="d-flex justify-content-between mt-3">
                <p-skeleton width="100px" height="2.5rem"></p-skeleton>
                <p-skeleton width="100px" height="2.5rem"></p-skeleton>
            </div>
        </div>
        <div class="right-profile">
            <div class="p-2 subs-holder mb-2">
                <p-skeleton width="40%" height="1.5rem" styleClass="mb-2"></p-skeleton>
                <div class="d-flex justify-content-between m-1">
                    <p-skeleton width="45%" height="1rem" styleClass="mb-1"></p-skeleton>
                    <p-skeleton width="45%" height="1rem" styleClass="mb-1"></p-skeleton>
                </div>
                <div class="d-flex justify-content-between m-1">
                    <p-skeleton width="45%" height="1rem" styleClass="mb-1"></p-skeleton>
                    <p-skeleton width="45%" height="1rem" styleClass="mb-1"></p-skeleton>
                </div>
            </div>
            <div class="m-2">
                <p-skeleton width="30%" height="2rem" styleClass="mb-3"></p-skeleton>
                <p-skeleton width="100%" height="2.5rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="100%" height="2.5rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="100%" height="2.5rem" styleClass="mb-2"></p-skeleton>
                <p-skeleton width="100%" height="2.5rem" styleClass="mb-2"></p-skeleton>
            </div>
        </div>
    </section>

    <!-- Actual Content -->
    <section class="main mx-auto d-flex flex-wrap justify-content-between" *ngIf="!isLoading">
        <div class="left-profile ">
            <div class="inner-profile pb-2">
                <img src="{{ avatar_file + singleClient.user.passport }}">
                <h1 class="m-2">{{singleClient.user.name}}</h1>

            </div>
            <b>Patient Details</b>
            <div class="d-flex subs mt-2 justify-content-between">
                <p class=" text-secondary">Date of birth:</p>
                <p class="">{{singleClient.date_of_birth | date}}</p>
            </div>
            <div class="d-flex subs justify-content-between">
                <p class=" text-secondary">Gender:</p>
                <p class="">{{singleClient.user.gender}}</p>
            </div>
            <hr>
            <b>Contact Information</b>
            <div class="d-flex subs mt-2 justify-content-between">
                <p class=" text-secondary">Phone Num:</p>
                <p class="">{{singleClient.user.phoneno}}</p>
            </div>
            <div class="d-flex subs justify-content-between">
                <p class=" text-secondary">Email:</p>
                <p class="">{{singleClient.user.email}}</p>
            </div>
            <div class="d-flex justify-content-between">

                <button pButton label="Message" class="message-button" icon="bi bi-chat-left-text-fill"
                    (click)="navigateToChat()" severity="info"></button>

                <button *ngIf="user.user_type != 'nurse'" pButton label="Assign" class="blue-button"
                    icon="bi bi-calendar-plus" severity="info" (click)="assign()"></button>
            </div>


        </div>
        <div class="right-profile">
            <div class="p-2 subs-holder" *ngIf="singleClient.appointments">
                <div *ngIf="singleClient.appointments.status=='Accepted'" class="">
                    <b>Last Appointment</b>

                    <div class="d-flex  appointment-container justify-content-between m-1">
                        <div class="d-flex">

                            <span>Patient Complaints:</span>
                            <p class="text-secondary">{{singleClient.appointments.symptoms}}</p>
                        
                            <span>Date:</span>
                            <p class="text-secondary">{{singleClient.appointments.date_time | date}}</p>
                        </div>
                        <div class="d-flex">
                            <span>Doctor:</span>
                            <p class="text-secondary">{{singleClient.appointments.doctor.user.name }}</p>
                        
                            <span class="fs-6">Status:</span>
                            <p-tag [rounded]="true" severity="success"
                                value="{{singleClient.appointments.status}}"></p-tag>

                        </div>
                    </div>
                </div>
                <div *ngIf="singleClient.appointments.status=='pending'">
                    <b>Current Appointment</b>

                    <div class="d-flex justify-content-between m-1">
                        <div class="">

                            <span>Patient Complaints:</span>
                            <p class="text-secondary">{{singleClient.appointments.symptoms}}</p>
                        </div>
                        <div class="">
                            <span>Date:</span>
                            <p class="text-secondary">{{singleClient.appointments.date_time | date}}</p>
                        </div>
                        <div class="">
                            <span>Doctor:</span>
                            <p class="text-secondary">{{singleClient.appointments.doctor.user.name }}</p>
                        </div>
                        <div class=" hold3">
                            <span class="fs-6">Status:</span>
                            <p-tag [rounded]="true" severity="warning"
                                value="{{singleClient.appointments.status}}"></p-tag>

                        </div>
                    </div>

                </div>

            </div>
            <div class="m-2">
                <h1 class="primary-color">Medical Records</h1>
                <p-table #dt1 dataKey="id" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]" [paginator]="true"
                  [value]="medicalRecords"  [globalFilterFields]="['nurse.user.name', 'nurses.specialization', 'representative.name', 'status']">


                    <ng-template pTemplate="caption">
                        <div class="d-flex justify-content-between">
                            <!-- <p-button pRipple label="Clear" size="small" [outlined]="true" icon="pi pi-filter-slash" /> -->
                            
                <p-button pRipple [rounded]="true" size="small" (click)="showMedRecDialog()" class="p-button-success p-button-outlined" icon="pi pi-plus-circle" />

                        </div>
                    </ng-template>
                    <ng-template pTemplate="header">
                        <tr>    
                            <th style="min-width:7rem">
                                <div class="flex align-items-center">
                                    View
                                    <!-- <p-columnFilter type="text" field="name" display="menu" /> -->
                                </div>
                            </th>

                            <th style="min-width:10rem">
                                <div class="flex align-items-center">
                                    Diagnosis
                                </div>
                            </th>
                            <th style="min-width:15rem">
                                <div class="flex align-items-center">
                                    Treatment
                                </div>
                            </th>

                            <th style="min-width:10rem">
                                <div class="flex align-items-center">
                                    Doctor
                                </div>
                            </th>

                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-medicalRecords>
                        <tr>
                            <td>
                                <p-button label="View" severity="info" [raised]="true"  [rounded]="true" (click)="openMedRecordView(medicalRecords)" />
                            </td>
                            <td class="d-flex">
                                {{medicalRecords?.diagnosis}}
                            </td>
                            <td>
                                {{medicalRecords?.treatment}}

                                <!-- <img src="https://primefaces.org/cdn/primeng/images/demo/flag/flag_placeholder.png" [class]="'flag flag-' + nurses.country.code" style="width: 20px" /> -->
                                <!-- <span class="ml-1 vertical-align-middle">{{ client.user.phoneno }}</span> -->
                            </td>

                            <td>
                                {{medicalRecords?.doctor.user.name}}

                            </td>


                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="7">No medical records found.</td>
                        </tr>
                    </ng-template>


                </p-table>

            </div>






        </div>
    </section>
</main>

<!-- Medical Record View Dialog -->
<p-dialog [(visible)]="viewMedRecordDialog" [modal]="true" [closable]="true" [style]="{width: '700px', maxWidth: '95vw'}" [baseZIndex]="10000" styleClass="modern-medical-record-view-dialog" [showHeader]="false">
  <div class="med-record-view-container">
    <!-- Compact Header -->
    <div class="med-record-view-header">
      <h3>Medical Record</h3>
      <button type="button" class="close-btn" (click)="viewMedRecordDialog=false" aria-label="Close">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <!-- Main Content -->
    <div class="med-record-view-body">
      <div id="printable-med-record">
        <!-- Patient Information -->
        <div class="patient-info-section">
          <div class="patient-photo-container">
            <img *ngIf="singleClient?.user?.passport" [src]="avatar_file + singleClient.user.passport" alt="Patient Photo" class="patient-photo" />
            <div *ngIf="!singleClient?.user?.passport" class="patient-photo-placeholder">
              <i class="pi pi-user"></i>
            </div>
          </div>
          <div class="patient-details-list">
            <div class="detail-row">
              <span class="detail-label">Patient:</span>
              <span class="detail-value">{{singleClient?.user?.name || 'N/A'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Record #:</span>
              <span class="detail-value record-number">{{selectedMedRecord?.record_number || 'N/A'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Doctor:</span>
              <span class="detail-value">{{selectedMedRecord?.doctor?.user?.name || 'N/A'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Specialization:</span>
              <span class="detail-value">{{selectedMedRecord?.doctor?.specialization || 'N/A'}}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Date:</span>
              <span class="detail-value">{{selectedMedRecord?.created_at ? (selectedMedRecord.created_at | date:'medium') : 'N/A'}}</span>
            </div>
          </div>
        </div>

        <!-- Medical Information Sections -->
        <div class="medical-sections-container">
          <div class="medical-section">
            <h4 class="section-title">Diagnosis</h4>
            <p class="section-text" *ngIf="selectedMedRecord?.diagnosis; else noDiagnosis">{{selectedMedRecord.diagnosis}}</p>
            <ng-template #noDiagnosis>
              <p class="section-text-empty">No diagnosis recorded</p>
            </ng-template>
          </div>

          <div class="medical-section">
            <h4 class="section-title">Past Diagnosis</h4>
            <p class="section-text" *ngIf="selectedMedRecord?.past_diagnosis; else noPastDiagnosis">{{selectedMedRecord.past_diagnosis}}</p>
            <ng-template #noPastDiagnosis>
              <p class="section-text-empty">No past diagnosis recorded</p>
            </ng-template>
          </div>

          <div class="medical-section">
            <h4 class="section-title">Treatment</h4>
            <p class="section-text" *ngIf="selectedMedRecord?.treatment; else noTreatment">{{selectedMedRecord.treatment}}</p>
            <ng-template #noTreatment>
              <p class="section-text-empty">No treatment prescribed</p>
            </ng-template>
          </div>

          <div class="medical-section">
            <h4 class="section-title">Allergies</h4>
            <p class="section-text" *ngIf="selectedMedRecord?.allergies; else noAllergies">{{selectedMedRecord.allergies}}</p>
            <ng-template #noAllergies>
              <p class="section-text-empty">No known allergies</p>
            </ng-template>
          </div>
        </div>

        <!-- Footer Information -->
        <div class="record-footer-info">
          <small>Generated by HMS | {{selectedMedRecord?.updated_at ? (selectedMedRecord.updated_at | date:'medium') : 'N/A'}}</small>
        </div>
      </div>
    </div>

    <!-- Action Footer -->
    <div class="med-record-view-footer">
      <button type="button" class="action-btn secondary-btn" (click)="viewMedRecordDialog=false">
        Close
      </button>
      <button type="button" class="action-btn primary-btn" (click)="printMedRecord()">
        <i class="pi pi-print"></i>
        Print
      </button>
    </div>
  </div>
</p-dialog>